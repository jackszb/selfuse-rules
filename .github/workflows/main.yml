name: Build ruleset

on:
  push:
    branches: [ master ]
    paths:
      - '*.json'
  workflow_dispatch:

jobs:
  compile-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        persist-credentials: true  # 允许 workflow push

    - name: Install sing-box
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        bash <(curl -fsSL https://sing-box.app/deb-install.sh)

    - name: Clean old .srs files
      run: |
        echo "Cleaning old .srs files in root..."
        rm -f *.srs || true

    - name: Compile all JSON files
      run: |
        echo "Compiling JSON files..."
        for file in *.json; do
          if [ -f "$file" ]; then
            output="${file%.json}.srs"
            echo "Compiling $file -> $output"
            sing-box rule-set compile --output "$output" "$file"
          fi
        done

    - name: List generated .srs files
      run: |
        echo "Generated .srs files in root:"
        ls -l *.srs || echo "No .srs files generated"

    - name: Commit generated .srs files
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add *.srs
        git diff --cached --quiet && echo "No changes to commit" || git commit -m "Update .srs files"
        git push
