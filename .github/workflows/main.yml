name: Build ruleset

on:
  push:
    branches: [ master ]
    paths:
      - '*.json'   # 根目录 JSON 文件变化时触发
  workflow_dispatch:

jobs:
  compile-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        persist-credentials: true  # 允许 workflow push

    - name: Download sing-box
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
        bash <(curl -fsSL https://sing-box.app/deb-install.sh)

    - name: Prepare output directory
      run: |
        mkdir -p dist
        echo "Cleaning old .srs files in dist/"
        rm -f dist/*.srs || true

    - name: Compile all JSON files
      run: |
        echo "Compiling JSON files..."
        for file in *.json; do
          if [ -f "$file" ]; then
            output="dist/${file%.json}.srs"
            echo "Compiling $file -> $output"
            sing-box rule-set compile --output "$output" "$file"
          fi
        done

    - name: Commit dist folder
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add dist/
        git diff --quiet && echo "No changes to commit" || git commit -m "Update dist folder"
        git push

    - name: List compiled files
      run: |
        echo "Generated .srs files in dist/:"
        ls -1 dist/
